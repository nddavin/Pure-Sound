# Pure Sound - Development Docker Environment
# Multi-stage build for development with full tooling

# Stage 1: Base - Python environment
FROM python:3.13-slim-bullseye as base

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive
ENV PIP_NO_CACHE_DIR=0
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsndfile1-dev \
    libopus0 \
    libmp3lame0 \
    libfdk-aac2 \
    libsamplerate0-dev \
    pkg-config \
    build-essential \
    git \
    curl \
    vim \
    nano \
    htop \
    && rm -rf /var/lib/apt/lists/*

# Stage 2: Builder - Install dependencies
FROM base as builder

WORKDIR /app

# Copy requirements files
COPY requirements.txt .
COPY requirements-dev.txt .

# Install Python dependencies
RUN pip install --upgrade pip && \
    pip install -r requirements.txt && \
    pip install -r requirements-dev.txt

# Stage 3: Development - Full development environment
FROM base as development

# Install development tools
RUN apt-get update && apt-get install -y \
    docker.io \
    docker-compose \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy Python dependencies from builder
COPY --from=builder /usr/local/lib/python3.13/site-packages /usr/local/lib/python3.13/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy application code
COPY . .

# Create non-root user with sudo access
RUN groupadd -r devuser && useradd -r -g devuser devuser && \
    echo "devuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    mkdir -p /home/devuser && chown -R devuser:devuser /home/devuser

# Install pre-commit hooks
USER devuser
WORKDIR /home/devuser

# Copy project files to home directory
RUN cp -r /app /home/devuser/project && \
    cd /home/devuser/project && \
    pip install -r requirements-dev.txt && \
    pre-commit install

WORKDIR /home/devuser/project

# Set default command
CMD ["/bin/bash"]
